<?php

namespace App\Controller;

use App\Entity\Covoiturage;
use App\Entity\StatutCovoiturage;
use App\Repository\VoitureRepository;
use Doctrine\ORM\EntityManagerInterface;
use Symfony\Bundle\FrameworkBundle\Controller\AbstractController;
use Symfony\Component\HttpFoundation\JsonResponse;
use Symfony\Component\HttpFoundation\Request;
use Symfony\Component\Routing\Annotation\Route;
use Psr\Log\LoggerInterface;

class USERCreerTrajetController extends AbstractController
{
    #[Route('/api/create_trajet', name: 'create_trajet', methods: ['POST'])]
    public function create(
        Request $request,
        EntityManagerInterface $em,
        VoitureRepository $voitureRepository,
        LoggerInterface $logger
    ): JsonResponse {
        $user = $this->getUser();

        if (!$user) {
            return $this->json([
                'success' => false,
                'message' => 'Utilisateur non connectÃ©'
            ], 401);
        }

        $data = json_decode($request->getContent(), true);
        $modele = $data['vehicule_id'] ?? null;

		// RÃ©cupÃ©rer l'objet StatutCovoiturage avec l'id 1
		$statut = $em->getRepository(StatutCovoiturage::class)->find(1);

		if (!$statut) {
			return $this->json([
				'success' => false,
				'message' => 'Statut covoiturage introuvable'
			], 400);
		}

        try {
            // Recherche de la voiture liÃ©e Ã  l'utilisateur
            $fullModele = $data['vehicule_id'] ?? null;
			$voiture = $voitureRepository->findOneByUtilisateurAndMarqueModele($user, $fullModele);

            if (!$voiture) {
                return $this->json([
                    'success' => false,
                    'message' => 'Voiture introuvable ou non liÃ©e Ã  cet utilisateur',
                    'user_id' => $user->getId(),
                    'username' => $user->getPseudo(),
                    'modele_vehicule' => $modele,
                ], 400);
            }

            // CrÃ©ation du trajet
            $trajet = new Covoiturage();
			
            $trajet->setVilleDepart($data['depart']);
            $trajet->setAdresseDepart($data['adresse_depart']);
            $trajet->setVilleArrivee($data['destination']);
            $trajet->setAdresseArrivee($data['adresse_arrivee']);
            $trajet->setDateDepart(new \DateTime($data['date_depart']));
            $trajet->setHeureDepart(new \DateTime($data['heure_depart']));
            $trajet->setDateArrivee(new \DateTime($data['date_arrivee']));
            $trajet->setHeureArrivee(new \DateTime($data['heure_arrivee']));

            $trajet->setPrixPassager($data['prix']);
			
            $trajet->setVoiture($voiture);
			
			$trajet->setNbPlace($data['places']);
			$trajet->setEstEcologique($data['est_ecologique'] ?? false);
			
            $trajet->setChauffeur($user);
            $trajet->setStatutCovoiturage($statut);
			
			$trajet->setDureeTrajet((int) $data['duree_minutes']); 
			$trajet->setDistanceTrajet($data['distance_km']);
			
            $em->persist($trajet);
            $em->flush();

		// Envoi du mail de confirmation
        $mailService->send(
            $user->getEmail(),
            "Confirmation de crÃ©ation de votre compte Ecoride",
            sprintf("Bonjour %s,

Votre covoiturage a bien Ã©tÃ© enregistrÃ© dans l'application Ecoride.

ğŸ—“ Date de crÃ©ation : %s
ğŸªª Pseudo : %s
ğŸ“© Adresse email : %s

Votre mot de passe n'est pas communiquÃ© par raison de sÃ©curitÃ©.
En cas d'oubli de vos identifiants, cliquer sur 'Mot de passe oubliÃ©' dans la page de connexion.

Vous pouvez dÃ©sormais utiliser la totalitÃ© des fonctionnalitÃ©s de l'application et Ã©galement complÃ©ter votre profil dans l'onglet 'Compte Utilisateur'.

Merci pour votre confiance et bon trajet !

Lâ€™Ã©quipe EcoRide",
            $trajet->setVilleDepart($data['depart']);
            $trajet->setAdresseDepart($data['adresse_depart']);
            $trajet->setVilleArrivee($data['destination']);
            $trajet->setPrixPassager($data['prix']);
			$trajet->setDureeTrajet((int) $data['duree_minutes']); 
			$trajet->setDistanceTrajet($data['distance_km']);
            $trajet->setVoiture($voiture);
            $trajet->setDateDepart(new \DateTime($data['date_depart']));
            $trajet->setHeureDepart(new \DateTime($data['heure_depart']));
			
			
                $trajet->getVilleDepart(),
                $trajet->getVilleArrivee(),
                $trajet->getVilleDepart(),
                $trajet->getVilleArrivee(),
                $trajet->getVilleDepart(),
                $trajet->setDureeTrajet(),
                $trajet->setDistanceTrajet(),
                $trajet->setVoiture()

            )
        );

            return $this->json([
                'success' => true,
                'trajet_id' => $trajet->getCovoiturageId()
            ]);
			
        } catch (\Exception $e) {
            return $this->json([
                'success' => false,
                'message' => 'Erreur serveur',
                'error' => $e->getMessage(),
                'data_received' => $data
            ], 500);
        }
    }
}
